{% if user.is_authenticated %}

    {% if form.errors %}
        <div class="error-list">
            <h3>Ошибки в основной форме:</h3>
            <ul>
                {% for field, errors in form.errors.items %}
                    <li>{{ field }}: {{ errors|join:", " }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if ingredient_formset.errors %}
        <div class="error-list">
            <h3>Ошибки в форме ингредиентов:</h3>
            <ul>
                {% for form in ingredient_formset %}
                    {% for field, errors in form.errors.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form  method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.name.label }} {{ form.name }}<br>
        {{ form.image.label }} {{ form.image }}<br>
        {{ form.short_description.label }} {{ form.short_description }}<br>
        <div>
            {{ form.categories.label }}<br>
            {% for category in form.fields.categories.queryset %}
                {% if not category.parent %}  <!-- Только корневые категории -->
                    <p><strong>{{ category.name }}</strong></p>
                    {% for subcategory in category.get_children %}
                        <input 
                            type="checkbox" 
                            name="categories" 
                            value="{{ subcategory.id }}" 
                            id="category_{{ subcategory.id }}"
                        />
                        <label for="category_{{ subcategory.id }}">{{ subcategory.name }}</label><br>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </div>
        {{ form.cooking_time.label }} {{ form.cooking_time }}<br>
        {{ form.quantity_of_servings.label }} {{ form.quantity_of_servings }}<br>
        <br>

        <div id="ingredient-forms">
            {{ ingredient_formset.management_form }}
            {% for form in ingredient_formset %}
                <div class="ingredient-form">
                    {{ form.as_p }}
                    {% if ingredient_formset.can_delete %}
                        <button type="button" class="delete-form">Удалить</button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <button type="button" id="add-ingredient">Добавить ингредиент</button>
        <br>
        <br>
        {{ form.cooking_steps.label }} {{ form.cooking_steps }}
        <button type="submit">Добавить рецепт</button>
    </form>

    <script>
        document.getElementById('add-ingredient').addEventListener('click', function() {
            const ingredientForms = document.getElementById('ingredient-forms');
            const totalForms = parseInt(document.getElementById('id_recipeingredient_set-TOTAL_FORMS').value);

            const newForm = ingredientForms.children[1].cloneNode(true);  // Клонируем форму ингредиента
            newForm.querySelectorAll('input, select').forEach(input => {
                input.name = input.name.replace(/-\d+-/, `-${totalForms}-`);
                input.id = input.id.replace(/-\d+-/, `-${totalForms}-`);
                input.value = '';
            });

            ingredientForms.appendChild(newForm);
            document.getElementById('id_recipeingredient_set-TOTAL_FORMS').value = totalForms + 1;
        });

        document.querySelectorAll('.delete-form').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.ingredient-form').remove();
            });
        });
    </script>

{% endif %}

